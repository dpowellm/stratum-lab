FROM python:3.11-slim

RUN apt-get update && apt-get install -y git build-essential curl && rm -rf /var/lib/apt/lists/*

# Separate layers to avoid pip resolver backtracking
RUN pip install --no-cache-dir openai anthropic requests httpx pydantic python-dotenv
RUN pip install --no-cache-dir litellm
RUN pip install --no-cache-dir crewai crewai-tools
RUN pip install --no-cache-dir langchain langchain-openai langchain-community langgraph
RUN pip install --no-cache-dir pyautogen

# Patcher injection â€” DO NOT CHANGE, confirmed working
COPY stratum_patcher/ /opt/stratum_patcher/
RUN echo "/opt" > $(python -c "import site; print(site.getsitepackages()[0])")/stratum.pth
RUN echo "import stratum_patcher" > $(python -c "import site; print(site.getsitepackages()[0])")/sitecustomize.py

RUN mkdir -p /app/output
WORKDIR /app
